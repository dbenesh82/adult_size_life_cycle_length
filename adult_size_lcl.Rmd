---
title: "Long life cycles and parasite reproductive sizes"
output: github_document
---

**Background**: A presumed benefit of a long, multi-host life cycle is that parasites reproduce in a big host that can facilitate parasite growth to a large size. I examine this presumed benefit using a [database](http://onlinelibrary.wiley.com/doi/10.1002/ecy.1680/suppinfo) of complex parasite life cycles. Then, I explore blah blah....

**Analysis**
First, import the libraries and the life cycle database.

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)

options(stringsAsFactors = FALSE) #never have species lists as factors; always as character vectors

#import the life cycle database data tables
setwd("C:/Users/phosp/OneDrive/Documents/Benesh/Proposals_ideas/DFG_eigenestelle/prelim_analyses/adult_size_lcl/")
dataH <- read.csv(file="CLC_database_hosts.csv", header = TRUE, sep=",")
dataL <- read.csv(file="CLC_database_lifehistory.csv", header = TRUE, sep=",")
```

We are interested in the reproductive stages in the definitive hosts, so we'll restrict the data to worms in the final host. We also remove all males before averaging, since female fecundity is supposed to correlate with host mass. Other factors, like intraspecific competition for mates is presumed to drive male size.

```{r}
# filter to adult stages
dataL <- filter(dataL, is.na(Asexual))%>% # remove data for asexual species
  filter(Stage == 'adult', (Sex == 'f' | is.na(Sex)) ) # remove adult males
```

Then we add a biovolume variable to the data and calculate the average for each parasite species.

```{r}
dataL <- mutate(dataL, biovolume = 
                  if_else(Shape %in% c("cylinder", "thread-like", "whip"), 
                          pi * (Width/2)^2 * Length, # calculate volume as a cylinder
                          if_else(Shape %in% c("coiled", "sphere", "ellipsoid"),
                                  4/3 * pi * Length/2 * Width/4, # calculate volume as a ellipsoid
                                  Length * Width # calculate volume as area for remaining ribbon, leaf shapes
                                  )),
                biovolume = biovolume * 1.1) # covert to biomass with assumed 1.1. g/cm3 tissue density 

# species averages
dataL.sp <- group_by(dataL, Parasite.species)%>%
  summarize(Biovolume = mean(biovolume, na.rm=T))
```

The data table now contains `r length(dataL.sp$Parasite.species)` species instead of the original 973 species. Some species were removed as they only had measurements for adult males.

```{r}
#add min and max life cycle length information to species level data
maxLCL <- group_by(dataH, Parasite.species)%>%summarize(maxLCL = max(Host.no))
minLCL <- filter(dataH, Facultative == "no")%>%
  group_by(Parasite.species)%>%summarise(minLCL = length(unique(Host.no)))
dataL.sp <- left_join(dataL.sp, maxLCL)
dataL.sp <- left_join(dataL.sp, minLCL)
```

Theme for plot.

```{r}
theme.o <- theme_update(axis.text = element_text(colour="black", size = 15),
                        axis.title = element_text(colour="black", size = 18, face = "bold", lineheight=0.25),
                        axis.ticks = element_line(colour="black"),
                        panel.border = element_rect(colour = "black",fill=NA),
                        panel.grid.minor=element_blank(),
                        panel.grid.major=element_line(color="gray",linetype = "dotted"),
                        panel.background= element_rect(fill = NA))
```

Plot the relationship. It is positive, as expected.

```{r}
#adult body size vs life cycle length plot

#let's try a scatter plot first
ggplot(data = dataL.sp,
       aes(x = maxLCL, y = log10(Biovolume))) +
  geom_point(alpha = 0.3, position = position_jitter(height = 0, width = 0.1)) +
  geom_smooth(method = 'lm', se = F) +
  labs(y="Log(Adult biovolume)\n", x="\nLife cycle length") 
```

A simple linear regression confirms that it is significantly positive. However, only 9% of the variation is explained by life cycle length.

```{r}
mdl <- lm(log10(Biovolume) ~ maxLCL, data = dataL.sp)
summary(mdl)
```

When we plot as boxplot, we see a clearer pattern.

```{r}
#make life cycle length a factor and combine few parasites with life cycles longer than three hosts together
dataL.sp <- mutate(dataL.sp, maxLCL.fac = if_else(maxLCL > 3, as.integer(4), maxLCL),
                   maxLCL.fac = factor(maxLCL.fac, labels = c("1", "2", "3", ">3")))

#boxplot with data points as overlay
ggplot(data = dataL.sp,
       aes(x = maxLCL.fac, y = log10(Biovolume))) + 
  geom_boxplot(outlier.color = "white", width = 0.9) +
  geom_jitter(width = 0.2, color = "red", alpha = 0.2) +
  labs(y="Log(Adult biovolume)\n", x="\nLife cycle length") + 
  theme(panel.grid.major.x = element_blank())
```

The analysis includes `r sum(!is.na(dataL.sp$Biovolume))` species.


Next, we explore why body size is only mildy associated with life cycle length.
We add two datasets: def host mass and def host trophic level (only for nematodes).

```{r}
#trophic vacuum dataset
setwd("C:/Users/Dan/OneDrive/Documents/Benesh/Research/Trophic vacuum/Revised/ProcB_submitted/SecondSubmission/Third_submission/Dryad")
tv_data <- read.csv(file = "TV_dryad.csv", header = TRUE, sep = ",")

#host mass dataset
load("C:/Users/Dan/OneDrive/Documents/Benesh/Research/LifeCycle_Database/HostMassData/Host_species_size_data.RData")
```




```{r}
#add host mass to parasite data
mv <- match(dataH$Host.species, simple.size.db$binomial)
dataH$host.mass <- simple.size.db$body.mass[mv]
#reduce host data
dataH.nemadult <- filter(dataH, Parasite.group == 'nematode', Stage == 'adult')%>% #take adult nematodes
  group_by(Parasite.species)%>%summarise(host.mass = mean(host.mass, na.rm=T)) #takes species avg
```


```{r}
#add trophic vacuum and host mass data to LH species averages
mv <- match(dataL.nemadult$Parasite.species, tv_data$Species)
dataL.nemadult <- cbind(dataL.nemadult, tv_data[mv, c('Min_TL', 'Max_TL', 'Avg_TL')])
mv <- match(dataL.nemadult$Parasite.species, dataH.nemadult$Parasite.species)
dataL.nemadult <- cbind(dataL.nemadult, dataH.nemadult[mv, 'host.mass'])
row.names(dataL.nemadult) <- 1:length(dataL.nemadult$Parasite.species)
```


```{r}
#correlation between def host TL and worm size
ggplot(dataL.nemadult, aes(x = Avg_TL, y = log10(Biovolume))) + 
  geom_point(position = position_jitter(width = 0.1, height = 0)) +
  theme_bw() + geom_smooth(method = 'lm', se = F, color = 'darkgray') +
  labs(x = "Definitive host trophic level", y = "Log10(Biovolume)")
out <- glm(log10(Biovolume) ~ Avg_TL, data = dataL.nemadult)
summary(out) #weak but sig
```


```{r}
#correlation between def host mass and worm size
qplot(data = dataL.nemadult, x = log10(host.mass), y = log10(Biovolume)) + theme_bw() + geom_smooth()
out <- glm(log10(Biovolume) ~ log10(host.mass), data = dataL.nemadult)
summary(out) #weak relationship
out <- glm(log10(Biovolume) ~ log10(host.mass) + Avg_TL, data = dataL.nemadult)
out <- glm(log10(Biovolume) ~ log10(host.mass) + Min_TL + Max_TL, data = dataL.nemadult)
summary(out) #body size and TL do not explain the same variance in parasite size
```

